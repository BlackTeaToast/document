## 如何创建密钥

開始使用InfluxDB服務前請確定您擁有以下資訊：

* 已成功購買InfluxDB實例

* 您的帳號擁有登入<span style="color:red;">Service Portal</span>的權限，並能看到所購買的實例

各站點Service Portal連結如下

 站點代碼 | 所在地點          | Service Portal連結                             |
 | -------- | ----------------- | ---------------------------------------------- |
 | SA       | Azure Singapore   | https://portal-service-ensaas.sa.wise-paas.com |
 | HZ       | Alibaba Hangzhou | https://portal-service-ensaas.hz.wise-paas.com.cn |
 | JE       | Japan East        | https://portal-service-ensaas.jp.wise-paas.com |

### 步驟一

登入Service Portal，並點選您的InfluxDB實例的操作按鈕，並選擇密鑰管理。

![Secret](./images/secret1.PNG)

### 步驟二

進入密鑰管理頁面後，請點選右上方的「+」按鈕創建密钥。

![Secret](./images/secret2.PNG)

### 步驟三

請輸入欲創建的密钥名稱，以及要將密钥建在哪一個集群、工作空間、命名空間之下。<br>
數據庫名稱若不填寫，則會自動建立一個亂數產生名稱的數據庫。<br>
所有資訊都輸入完成後請按下確定。

![Secret](./images/secret3.PNG)

### 步驟四

若密鑰創建成功，將在清單上看到所創建的密鑰，您可以點選操作 > 查看以檢視密鑰內容。

![Secret](./images/secret4.PNG)

### 步驟五

查看創建出來的連線憑證，連線憑證是一組包含數據庫連線位址、連線帳號、連線密碼等資訊的JSON格式文檔。

![Secret](./images/secret5.PNG)

 * database：字串型態，若是自動產生的名稱，則是標準UUID格式
 * host：字串型態，數據庫所在位址，為內部網路存取位址，IP格式
 * password：字串型態，由小寫英文字母與數字隨機組成，長度為25字元
 * port：數值型態，表示數據庫通訊埠
 * uri：字串型態，格式為http://\<host\>:\<port\>
 * username：字串型態，是標準UUID格式



### 步驟三：將Secret的資訊注入到Kubernetes Pods中

------

完成上一步驟在Namespace創建Secret後，可以在namespace裡看到一個同名的Secret。查看Secret內容後，會看到一個Key值為ENSAAS_SERVICES的內容，從kubctl指令看到的是base64編碼後的內容，可將其base64解碼後，或是注入到環境變數後取得原本得Credential內容。

```shell
$ kubectl -n my-namespace get secret
$ kubectl -n my-namespace get secret influxdb-secret -o yaml
```

![1582025913841](../uploads/images/InfluxDB/influxdb_secret.png)



創建一個Pod(以busybox為例)，並將Secret注入到Pod環境變數中，並從環境變數中取得Credential內容

- spec.cotainers.env.name: 注入到Pod的環境變數名稱
- spec.cotainers.env.valueFrom.secretKeyRef.name: 注入的來源為同Namespace底下，名為influxdb-secret的Secret
- pec.cotainers.env.valueFrom.secretKeyRef.key: Secret中的Key值，EnSaaS創建出來的Key名稱固定為"ENSAAS_SERVICES"

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: my-namespace
spec:
  containers:
  - name: busybox
    image: busybox:latest
    env:
    - name: ENSAAS_SERVICES
      valueFrom:
        secretKeyRef:
          name: influxdb-secret
          key: ENSAAS_SERVICES
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
```

進入到Pod裡面執行env的指令，就可以取得JSON格式的influxdb credential了

```shell
$ kubectl -n my-namespace exec -ti busybox sh
$ env
```

![1582025913841](../uploads/images/InfluxDB/influxdb_secret_env.png)

### 步驟四：程式在環境變數中獲取連線憑證，並與InfluxDB進行連線

---------------------------------------
當您有連線憑證後，您就可以搭配您所熟悉的客戶端應用來使用InfluxDB的服務。

* <a class="false-class" href="#!documents/Database/InfluxDb/userguide__zh-TW.md#Java開發者">Java開發者</a>
* <a class="false-class" href="#!documents/Database/InfluxDb/userguide__zh-TW.md#Python開發者">Python開發者</a>
* <a class="false-class" href="#!documents/Database/InfluxDb/userguide__zh-TW.md#NodeJs開發者">NodeJs開發者</a>
